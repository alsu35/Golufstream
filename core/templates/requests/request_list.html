<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8" />
    <title>Список заявок</title>
    <meta name="csrf-token" content="{{ csrf_token }}">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    {% load static %}
    <link rel="icon" href="{% static 'img/favicon.png' %}" type="image/png" />
    <link rel="shortcut icon" href="{% static 'img/favicon.ico' %}" type="image/x-icon" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

    <!-- Bootstrap CSS уже должен быть подключён -->
    <link
    href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"
    rel="stylesheet"
    />
    <link
    href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.4.0/dist/select2-bootstrap-5-theme.min.css"
    rel="stylesheet"
    />

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script
    src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.full.min.js"
    ></script>


    <!-- Flatpickr CSS -->
    <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet" />
    <!-- в <head> -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <!-- перед </body> -->
    <style>
        body {
            background-color: #f8f9fa;
        }

        .container {
            max-width: 100%;
            margin-right: 20px;
        }

        .sortable {
            cursor: pointer;
            position: relative;
        }

        .sortable::after {
            content: "▼";
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.8em;
            color: white;
            opacity: 0.5;
        }

        .sortable.asc::after {
            content: "▲";
            opacity: 1;
        }

        .sortable.desc::after {
            content: "▼";
            opacity: 1;
        }
        table thead th {
            font-size: clamp(0.8rem, 0.4rem + 0.7vw, 1.2rem);
        }
        td {
            font-size: clamp(0.6rem, 0.4rem + 0.9vw, 0.95rem)
        }
        .search-filter-container {
            display: flex;
            flex-direction: column;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .search-filter-row {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            justify-content: center;
            align-items: center;
            overflow-x: visible;
        }

        .search-filter-row>* {
            flex: 1 1 180px;
            max-width: 350px;
            min-width: 150px;
            box-sizing: border-box;
        }

        
        .search-filter-container .form-select {
            max-width: 200px;
            width: 100%;
            box-sizing: border-box;
            margin: 0;
            font-size:calc(0.5rem + 0.4vw);
            height: 38px;
        }

        .search-filter-container .form-control {
            margin: auto 0;
            font-size: calc(0.5rem + 0.4vw);
            height: 38px;
        }
        .search-filter-dates {
            margin-top: 1rem;
            flex-wrap: wrap;
            justify-content: center;
            display: flex;
            gap: 0.75rem;
        }
        .search-filter-dates .form-control {
            min-height: 38px;
            min-width: 100px;
        }

        .table-container {
            overflow-x: auto;
            position: relative;
        }
        h5{
            font-size:calc(0.8rem + 0.4vw);
        }
        h6{
            font-size:calc(0.7rem + 0.4vw);
        }

        /*
        * Стили для "закреплённой" колонки действий (кнопки: Подробнее, Редактировать и т.д.)
        * Используется position: sticky, центрирование кнопок внутри ячейки
        */
        .table thead th.actions,
        .table tbody td.actions {
            position: sticky;
            left: 0;
            background-color: #fff;
            z-index: 1;
            box-shadow: 1px 0 0 rgba(0, 0, 0, 0.1);
        }

        /* Центрирование кнопок внутри .actions */
        .actions {   
            align-items: center;           /* небольшой отступ между кнопками */
            text-align: center;            /* уменьшенный внутренний отступ */
            white-space: nowrap;         /* запрет переноса кнопок на новую строку (опционально) */
        }
        .table thead th.actions {
            background-color: #343a40;
        }

        .status-badge {
            font-weight: bold;
            padding: 0.4em 0.8em;
            border-radius: 5px;
            color: #333;
            font-size: 0.9rem;
        }

        .change-status {
        /* можно задать отступы и min-width */
        display: inline-block;
        text-align: center;
        }

        /* Цветовые варианты */
        .change-status.status-new {
        background-color: #f4d867;
        }
        .change-status.status-assigned {
        background-color: #d1b3ff;
        }
        .change-status.status-work {
        background-color: #b2eac3;
        }
        .change-status.status-done {
        background-color: #88c9ed;
        }
        .change-status.status-cancel {
        background-color: #ff9696;
        }

         /* Адаптивный размер текста кнопок */
        .btn-responsive span.text {
            font-size: calc(0.5rem + 0.4vw); 
            white-space: nowrap;
        }
        /* Иконки по умолчанию скрыты */
        .btn-responsive i {
            display: none;
        }
        /* Если это селект — уберём стандартный белый фон и применим перекраску */
        .change-status.form-select {
        color: #333;
        border: none;
        }

        .btn-double{
            background: transparent;
            color: #4ca15e;
            border: 1px solid #4ca15e;
            margin-top: 2px;
        }

        .btn-double:hover {
            opacity: 0.9;
            color: white;
            background:#4ca15e;;
        }

        .btn-edit {
            background: transparent;
            color: #574ca1;
            border: 1px solid #574ca1;
            margin-top: 2px;
        }

        .btn-edit:hover {
            opacity: 0.9;
            color: white;
            background: linear-gradient(135deg, #574ca1, #4da4cb);
        }

        .btn-logout {
            background: #e9ecef;
            color: #333;
            border: none;
            margin-right: 1rem;
            border: 1px solid #198754;
        }

        .btn-logout:hover {
            background: #198754;
            color: white;
        }

        .date-range {
            display: flex;
            gap: 0.5rem;
        }

        .date-range input {
            flex: 1;
        }

        .fio {
            font-size: calc(0.5rem + .7vw);
        }

        .select2-results__option {
            white-space: normal !important;
            padding: 0.5rem 1rem !important;
        }

        .select2-selection__rendered {
            white-space: normal !important;
        }

        /* Перенос длинных названий в Select2 */
        .select2-container--bootstrap-5 .select2-selection__rendered {
        white-space: normal;      /* переход на новую строку */
        line-height: 1.2;         /* чуть компактнее */
        }

        /* Скрываем крестик очистки */
        .select2-container--bootstrap-5 .select2-selection__clear {
        display: none !important;
        }

        /* Стили для каждой опции: ФИО + должность */
        .select2-container--bootstrap-5 .select2-results__option .option-title {
            display: block;
            font-weight: 600;
        }
        .select2-container--bootstrap-5 .select2-results__option .option-sub {
            display: block;
            font-size: 0.85em;
            color: #6c757d;
        }
        .date-filter-container .text-nowrap {
            display: none;
        }


        .date-filter-container .form-control {
            max-width: 90px;
            font-size: 0.7rem;
            height: calc(1.8rem + 0.2vh);
        }

        /* Адаптивный размер текста */
        .date-filter-container .text-nowrap,
        label {
            font-size: calc(0.7rem + 0.3vw);
        }

        /* Высота полей ввода */
        .date-filter-container .form-control {
            height: calc(2rem + 0.2vh); /* адаптивная высота */
            font-size: calc(0.65rem + 0.2vw);
            padding: 0 0.5rem;
        }

          /* Убираем внутренние отступы у td или делаем их минимальными */
        .table td.status,
        .table td.responsible {
            padding-left: 0.5rem;
            padding-right: 0.5rem;
            white-space: nowrap;
        }

        /* Минимальная ширина для ячеек */
        .table td.status {
            min-width: 100px;
        }

        .table td.responsible {
            min-width: 120px;
        }

        /* Для селекта — убираем стандартный padding у form-select */
        .table td.responsible .form-select {
            padding-left: 0.35rem;
            padding-right: 0.35rem;
            font-size: 0.8rem;
        }

        /* Если используется status-badge — тоже делаем компактным */
        .table td.status .status-badge {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }
        .select2-container--bootstrap-5 .select2-selection--single .select2-selection__rendered {
            margin-top: -30px; /* Поднимаем текст немного вверх */
        }

        @media (max-width: 1570px) {
            #requestsTable th:nth-child(13),
            #requestsTable td:nth-child(13) {
                display: none;
            }
        }

        @media (max-width: 932px) {
            .search-filter-dates {
                justify-content: flex-start;
                gap: 0.5rem;
            }

            
            .search-filter-container .form-select {
                min-width: auto;
                width: 100%;
                box-sizing: border-box;
            }

            
        }

        @media (max-width: 765px) {
            .btn span.d-none.d-sm-inline {
                display: none !important;
            }

            .btn i.d-sm-none {
                display: inline-block !important;
                margin-left: 0;
                font-size: 1.3rem;
                vertical-align: middle;
            }

            .btn i.me-1 {
                display: none !important;
            }

            .btn.d-inline-flex {
                align-items: center;
                justify-content: center;
            }
            .btn-responsive {
                margin-right: 0 !important; 
                gap: 0 !important;  
                display: inline-block !important;       
            }
            .btn-responsive span.text {
                display: none;

            }
            .btn-responsive i {
                display: inline-block;
                margin-right: 0;
                display: block;
            }
            .table>:not(caption)>*>*{
                padding: .2rem .3rem !important;
            }
            .search-filter-container{
                margin-bottom: .7rem !important;
                padding: .5rem !important;
            }
            .text-nowrap {
                display: none;
            }

            .btn-work-data .text {
                display: none;
            }

            .search-filter-container .form-select,
            .search-filter-container .form-control  {
                height: 30px !important;
            }
            .gap-3 {
                gap: .4rem !important;
            }
            .mb-3 {
                margin-bottom: .4rem !important;
            }
            .mt-3 {
                margin-top: .4rem !important;
            }
            .search-container{
                margin-top: .5rem !important;
            }
        }

        @media (max-width: 350px) {
            .btn.btn-success.btn-sm,
            .btn.btn-outline-secondary.btn-sm {
                padding: 0.25rem 0.5rem;
                font-size: 0.75rem;
                height: 30px;
            }

            .d-flex.flex-column.align-items-center.gap-1 {
                display: none !important;
            }
        }
    </style>
</head>

<body type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
    <div class="container py-3">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>Список заявок</h2>
            <!-- Информация о пользователе -->
            <div class="d-flex flex-column align-items-center gap-1">
                <p class="mb-0 text-center"><small>{{ request.user.email }}</small></p>
                {% if profile %}
                <p class="mb-0 fw-bold text-center fio">{{ profile.full_name }}</p>
                {% endif %}
                

            </div>
            <!-- Кнопки -->
            <div class="d-flex flex-column align-items-end gap-1">
                <div class="d-flex flex-wrap gap-2 justify-content-end">
                    {% if profile and profile.role.code in 'operator,customer' %}
                    <a href="{% url 'request_create' %}"
                        class="btn btn-success btn-sm d-inline-flex align-items-center">
                        <i class="bi bi-plus-circle me-1"></i>
                        <span class="d-none d-sm-inline">Создать заявку</span>
                        <i class="bi bi-plus-circle d-sm-none"></i>
                    </a>
                    {% endif %}
                    <a href="/logout/" class="btn btn-outline-secondary btn-sm d-inline-flex align-items-center">
                        <i class="bi bi-box-arrow-right me-1"></i><span class="d-none d-sm-inline">Выход</span>
                        <i class="bi bi-box-arrow-right d-sm-none"></i>
                    </a>
                </div>
            </div>

        </div>

        <!-- Фильтры и поиск -->
        <div class="search-filter-container">
            <div class="container">
                <div class="row justify-content-center">
                    <!-- Левая колонка: фильтры -->
                    <div class="col-12 col-md-6 mb-4 mb-md-0">
                        <div class="d-flex flex-column align-items-center">
                            <!-- Блок фильтров -->
                            <div class="filter-row d-flex flex-wrap justify-content-center gap-3 w-100 mb-3">
                                <!-- Фильтр по статусу -->
                                <select id="statusFilter" class="form-select w-auto flex-grow-1">
                                    <option value="">Все статусы</option>
                                    {% for status in statuses %}
                                    <option value="{{ status.code }}">{{ status.name }}</option>
                                    {% endfor %}
                                </select>

                                <!-- Фильтр по локации -->
                                {% if not profile or profile.role.code == 'employee' %}
                                <select id="locationFilter" class="form-select w-auto flex-grow-1">
                                    <option value="">Все локации</option>
                                    {% for location in locations %}
                                    <option value="{{ location.code }}">{{ location.name }}</option>
                                    {% endfor %}
                                </select>
                                {% endif %}

                                <!-- Фильтр по категории -->
                                <select id="categoryFilter" class="form-select w-auto flex-grow-1">
                                    <option value="">Все категории</option>
                                    {% for category in categories %}
                                    <option value="{{ category.code }}">{{ category.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <!-- Период -->
                            <div class="w-100 d-flex justify-content-center">
                                <div class="d-flex align-items-center gap-2">
                                    <span class="text-nowrap">Период:</span>
                                    <input type="text" id="dateStartFilter" class="form-control" placeholder="От" style="max-width: 120px;" />
                                    <input type="text" id="dateEndFilter" class="form-control" placeholder="До" style="max-width: 120px;" />
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Правая колонка: поиск + кнопки -->
                    <div class="col-12 col-md-6">
                        <div class="d-flex flex-column align-items-center">
                            <!-- Поиск -->
                            <div class="col-12 no-row-gap align-items-center" style="max-width: 630px;">
                                <!-- Контейнер для label и кнопки "+" -->
                                <div class="d-flex justify-content-between align-items-center mb-2 w-100">
                                    <label for="searchInput" class="form-label text-center mb-0">
                                        Поиск по заявкам
                                    </label>
                                    <button id="add-search-btn" type="button" class="btn btn-outline-primary btn-sm position-relative">
                                        <i class="bi bi-plus-lg"></i>
                                    </button>
                                </div>

                                <!-- Контейнер для поиска -->
                                <div class="d-flex justify-content-center w-100 mb-1">
                                    <div class="w-100" style="max-width: 630px;">
                                        <div class="input-group">
                                            <input type="text" id="searchInput" class="form-control" placeholder="Поиск по заявкам..." />
                                        </div>
                                    </div>
                                </div>

                                <!-- Динамические строки поиска -->
                                <div class="d-flex justify-content-center w-100" >
                                    <div id="add-search-container" class="w-100"style="max-width: 630px;"></div>
                                </div>

                                <!-- Скрытое поле -->
                                <input type="hidden" id="searchConditions" name="search_conditions" />
                            </div>
                            <!-- Блок кнопок -->
                            <div class="w-100 mt-3 d-flex justify-content-end gap-2 btn-work-data">
                                <button id="clearAllFilter" class="btn btn-outline-secondary btn-sm d-flex align-items-center gap-1" type="button">
                                    <i class="bi bi-x-circle icon"></i>
                                    <p class="text mb-0">Сбросить</p>
                                </button>
                                <button id="saveFiltersBtn" class="btn btn-outline-primary btn-sm d-flex align-items-center gap-1" type="button">
                                    <i class="bi bi-funnel"></i> 
                                    <p class="text mb-0">Сохранить фильтры</p>
                                </button>
                                <button id="exportExcelBtn" class="btn btn-success btn-sm d-flex align-items-center gap-1" type="button">
                                    <i class="bi bi-file-earmark-spreadsheet"></i> 
                                    <p class="text mb-0">В Excel</p>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Модальное окно -->
        <div class="modal fade" id="exportColumnsModal" tabindex="-1" aria-labelledby="exportColumnsModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                <div class="modal-header justify-content-between">
                    <h5 class="modal-title" id="exportColumnsModalLabel">Выберите столбцы для экспорта</h5>
                    <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">Отмена</button>
                </div>
                <div class="modal-body">
                    <div class="row g-2">
                    <!-- Группы столбцов -->
                    <div class="col-md-6">
                        <h6>Основные данные</h6>
                        <div class="form-check" data-column="ID">
                            <input class="form-check-input column-checkbox" type="checkbox" value="ID" id="col-ID">
                            <label class="form-check-label" for="col-ID">ID</label>
                        </div>
                        <div class="form-check" data-column="Дата подачи">
                            <input class="form-check-input column-checkbox" type="checkbox" value="Дата подачи" id="col-Дата подачи">
                            <label class="form-check-label" for="col-Дата подачи">Дата подачи</label>
                        </div>
                        <div class="form-check" data-column="Время подачи">
                            <input class="form-check-input column-checkbox" type="checkbox" value="Время подачи" id="col-Время подачи">
                            <label class="form-check-label" for="col-Время подачи">Время подачи</label>
                        </div>
                        <div class="form-check" data-column="Подразделение">
                            <input class="form-check-input column-checkbox" type="checkbox" value="Подразделение" id="col-Подразделение">
                            <label class="form-check-label" for="col-Подразделение">Подразделение</label>
                        </div>
                        <div class="form-check" data-column="Ответственный">
                            <input class="form-check-input column-checkbox" type="checkbox" value="Ответственный" id="col-Ответственный">
                            <label class="form-check-label" for="col-Ответственный">Ответственный</label>
                        </div>
                        <div class="form-check" data-column="Заказчик">
                            <input class="form-check-input column-checkbox" type="checkbox" value="Заказчик" id="col-Заказчик">
                            <label class="form-check-label" for="col-Заказчик">Заказчик</label>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <h6>Работы</h6>
                        <div class="form-check" data-column="Дата начала работы">
                            <input class="form-check-input column-checkbox" type="checkbox" value="Дата начала работы" id="col-Дата начала работы">
                            <label class="form-check-label" for="col-Дата начала работы">Дата начала работы</label>
                        </div>
                        <div class="form-check" data-column="Дата окончания работы">
                            <input class="form-check-input column-checkbox" type="checkbox" value="Дата окончания работы" id="col-Дата окончания работы">
                            <label class="form-check-label" for="col-Дата окончания работы">Дата окончания работы</label>
                        </div>
                        <div class="form-check" data-column="Время начала работ">
                            <input class="form-check-input column-checkbox" type="checkbox" value="Время начала работ" id="col-Время начала работ">
                            <label class="form-check-label" for="col-Время начала работ">Время начала работ</label>
                        </div>
                        <div class="form-check" data-column="Время окончания работ">
                            <input class="form-check-input column-checkbox" type="checkbox" value="Время окончания работ" id="col-Время окончания работ">
                            <label class="form-check-label" for="col-Время окончания работ">Время окончания работ</label>
                        </div>
                        <div class="form-check" data-column="Окончание работ по факту">
                            <input class="form-check-input column-checkbox" type="checkbox" value="Окончание работ по факту" id="col-Окончание работ по факту">
                            <label class="form-check-label" for="col-Окончание работ по факту">Окончание работ по факту</label>
                        </div>
                        <div class="form-check" data-column="Объем работы (ч)">
                            <input class="form-check-input column-checkbox" type="checkbox" value="Объем работы (ч)" id="col-Объем работы (ч)">
                            <label class="form-check-label" for="col-Объем работы (ч)">Объем работы (ч)</label>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <h6>Детали</h6>
                        <div class="form-check" data-column="Локация">
                            <input class="form-check-input column-checkbox" type="checkbox" value="Локация" id="col-Локация">
                            <label class="form-check-label" for="col-Локация">Локация</label>
                        </div>
                        <div class="form-check" data-column="Категория">
                            <input class="form-check-input column-checkbox" type="checkbox" value="Категория" id="col-Категория">
                            <label class="form-check-label" for="col-Категория">Категория</label>
                        </div>
                        <div class="form-check" data-column="Вид транспорта">
                            <input class="form-check-input column-checkbox" type="checkbox" value="Вид транспорта" id="col-Вид транспорта">
                            <label class="form-check-label" for="col-Вид транспорта">Вид транспорта</label>
                        </div>
                        <div class="form-check" data-column="Вид работ">
                            <input class="form-check-input column-checkbox" type="checkbox" value="Вид работ" id="col-Вид работ">
                            <label class="form-check-label" for="col-Вид работ">Вид работ</label>
                        </div>
                        <div class="form-check" data-column="Объект работ">
                            <input class="form-check-input column-checkbox" type="checkbox" value="Объект работ" id="col-Объект работ">
                            <label class="form-check-label" for="col-Объект работ">Объект работ</label>
                        </div>
                        <div class="form-check" data-column="Комментарий">
                            <input class="form-check-input column-checkbox" type="checkbox" value="Комментарий" id="col-Комментарий">
                            <label class="form-check-label" for="col-Комментарий">Комментарий</label>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <h6>Персонал</h6>
                        <div class="form-check" data-column="Статус">
                            <input class="form-check-input column-checkbox" type="checkbox" value="Статус" id="col-Статус">
                            <label class="form-check-label" for="col-Статус">Статус</label>
                        </div>
                        <div class="form-check" data-column="Номер удостоверения ответственного">
                            <input class="form-check-input column-checkbox" type="checkbox" value="Номер удостоверения ответственного" id="col-Номер удостоверения ответственного">
                            <label class="form-check-label" for="col-Номер удостоверения ответственного">Номер удостоверения ответственного</label>
                        </div>
                        <div class="form-check" data-column="ФИО стропольщика">
                            <input class="form-check-input column-checkbox" type="checkbox" value="ФИО стропольщика" id="col-ФИО стропольщика">
                            <label class="form-check-label" for="col-ФИО стропольщика">ФИО стропольщика</label>
                        </div>
                        <div class="form-check" data-column="Номера удостоверений стропольщиков">
                            <input class="form-check-input column-checkbox" type="checkbox" value="Номера удостоверений стропольщиков" id="col-Номера удостоверений стропольщиков">
                            <label class="form-check-label" for="col-Номера удостоверений стропольщиков">Номера удостоверений стропольщиков</label>
                        </div>
                        <div class="form-check" data-column="Перерывы">
                            <input class="form-check-input column-checkbox" type="checkbox" value="Перерывы" id="col-Перерывы">
                            <label class="form-check-label" for="col-Перерывы">Перерывы</label>
                        </div>
                    </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="resetColumnsBtn" type="button" class="btn btn-outline-secondary btn-sm" >Сбросить</button>
                    <button id="saveExportColumnsBtn" type="button" class="btn btn-primary btn-sm" data-bs-dismiss="modal">Сохранить</button>
                </div>
                </div>
            </div>
        </div>

        <!-- Таблица заявок -->
        <div class="table-container">
            <table id="requestsTable" class="table table-striped table-hover align-middle">
                <thead class="table-dark">
                    <tr>
                        <th class="actions" style="left: 0; z-index: 1">Действия</th>
                        <th>#</th>
                        <th id="sortDateHeader" class="sortable">Дата подачи</th>
                        <th>Период работ</th>
                        <th>Вид транспорта</th>
                        <th>Вид работ</th>
                        <th>Объект работ</th>
                        <th>Статус</th>
                        <th>Заказчик</th>
                        <th>Подразделение</th>
                        <th>Ответственный</th>
                        <th>Перерывы</th>
                        {% if not profile or profile.role.code == 'employee' %}
                        <th>Локация</th>
                        {% endif %}
                        <th>Категория техники</th>
                    </tr>
                </thead>
                <tbody>
                    {% for req in requests %}
                        <tr 
                            data-id="{{ req.id }}"
                            created-at="{{ req.created_at|date:'c' }}"
                            data-submitted="{{ req.created_at|date:'c' }}"
                            data-status-id="{{ req.status.id }}"
                            data-status="{{ req.status.code }}"
                            data-status-name="{{ req.status.name }}"
                            data-location="{{ req.location.code }}"
                            data-location-name="{{ req.location.name }}"
                            data-equipment-category="{{ req.equipment_category.code }}"
                            data-equipment-category-name="{{ req.equipment_category.name }}"
                            data-customer="{% if req.customer %}{{ req.customer.full_name|lower }}{% endif %}"
                            data-responsible="{% if req.responsible %}{{ req.responsible.full_name|lower }}{% endif %}"
                            data-work-type="{{ req.work_type|lower }}"
                            data-work-object="{{ req.work_object|lower }}"
                            data-transport-type="{{ req.transport_type|lower }}"
                            data-department="{{ req.customer.department.name|lower }}"
                            data-date-start="{{ req.date_start|date:'Y-m-d' }}"
                            data-date-end="{{ req.date_end|date:'Y-m-d' }}"
                            data-time-start="{{ req.time_start|time:'H:i' }}"
                            data-time-end="{{ req.time_end|time:'H:i' }}"
                            data-is-completed-fact="{{ req.is_completed_fact|yesno:'yes,no' }}"
                            data-break-periods='{{ req.break_periods_json|safe }}'
                            data-comment="{{ req.comment }}"
                            data-responsible-id-card="{{ req.responsible_certificate }}"
                            data-slingers='{"names": "{{ req.rigger_name }}", "certificates": "{{ req.rigger_certificates }}"}'
                            class="status-{{ req.status.code }}"
                        >
                        <!-- Действия, ID и Дата подачи -->
                        <td class="actions" style="left: 0; z-index: 1">
                            <!-- Подробнее -->
                            <a href="{% url 'request_detail' req.pk %}" class="btn btn-sm btn-outline-primary me-1 btn-responsive d-flex align-items-center gap-1">
                                <i class="bi bi-eye"></i>
                                <span class="text">Подробнее</span>
                            </a>

                            {% if profile and profile.role.code in 'operator,customer' and req.status.code == 'new' or req.status.code == 'assigned' %}
                                <!-- Редактировать -->
                                <a href="{% url 'request_update' req.id %}" class="btn btn-sm btn-edit me-1 btn-responsive d-flex align-items-center gap-1">
                                <i class="bi bi-pencil-square"></i>
                                <span class="text">Редактировать</span>
                                </a>
                            {% endif %}

                            {% if profile.role.code == 'customer' and req.status.code != 'cancel' and req.status.code != 'done' and req.status.code != 'work' %}
                                <!-- Отменить -->
                                <a href="{% url 'request_cancel' req.id %}" class="btn btn-sm btn-outline-danger mt-1 btn-responsive d-flex align-items-center gap-1">
                                <i class="bi bi-x-circle"></i>
                                <span class="text">Отменить</span>
                                </a>
                            {% endif %}

                            {% if profile and profile.role.code in 'operator,customer' %}
                                <!-- Дублировать -->
                                <a href="{% url 'request_double' req.id %}" class="btn btn-sm btn-double me-1 btn-responsive d-flex align-items-center gap-1">
                                    <i class="bi bi-files"></i>
                                    <span class="text">Дублировать</span>
                                </a>
                            {% endif %}
                            </td>
                        <td>{{ req.id }}</td>
                        <td>
                            <small class="text-muted">
                                {{ req.created_at|date:"d.m.Y H:i" }}
                            </small>
                        </td>

                        <!-- Период работ -->
                        <td>
                            <div>
                                <small class="text-muted">
                                    {% if req.date_start != req.date_end %}
                                    {{ req.date_start|date:"d.m" }} – {{ req.date_end|date:"d.m" }}
                                    {% else %}
                                    {{ req.date_start|date:"d.m" }}
                                    {% endif %}
                                </small><br>
                                <span class="badge bg-light text-dark border mt-1">
                                    {{ req.time_start|time:"H:i" }} – {{ req.time_end|time:"H:i" }}
                                </span>
                            </div>
                        </td>

                        <!-- Вид транспорта -->
                        <td>{{ req.transport_type }}</td>

                        <!-- Вид работ -->
                        <td>{{ req.work_type }}</td>

                        <!-- Объект работ -->
                        <td>{{ req.work_object }}</td>

                        <!-- Статус -->
                        <td class="status">
                        {% if profile.role.code == 'operator' %}
                            <select class="form-select form-select-sm change-status" data-id="{{ req.id }}">
                            {% for s in statuses %}
                                <option value="{{ s.id }}" data-code="{{ s.code }}" {% if s.id == req.status.id %}selected{% endif %}>
                                {{ s.name }}
                                </option>
                            {% endfor %}
                            </select>
                        {% else %}
                            <span class="status-badge change-status status-{{ req.status.code }}" data-code="{{ req.status.code }}">
                            {{ req.status.name }}
                            </span>
                        {% endif %}
                        </td>

                        <!-- Заказчик и Подразделение -->
                        <td>{{ req.customer.full_name }}</td>
                        <td>{{ req.customer.department.name }}</td>

                        <!-- Ответственный -->
                        <td class="responsible">
                        {% if profile.role.code == 'operator' %}
                            <select class="form-select form-select-sm change-responsible" data-id="{{ req.id }}" style="width: 140px;">
                            <option value="">—</option>
                            {% for u in responsibles %}
                                <option value="{{ u.id }}" {% if req.responsible and u.id == req.responsible.id %}selected{% endif %} data-position="{{ u.position }}">
                                {{ u.full_name }}
                                </option>
                            {% endfor %}
                            </select>
                        {% else %}
                            {% if req.responsible %}
                            {{ req.responsible.full_name }} — {{ req.responsible.position }}
                            {% else %}
                            —
                            {% endif %}
                        {% endif %}
                        </td>
                    </div>


                        <!-- Перерывы -->
                        <td>
                            {% if req.break_periods %}
                            <div class="d-flex flex-wrap gap-1">
                                {% for br in req.break_periods %}
                                <span class="badge bg-secondary">{{ br }}</span>
                                {% endfor %}
                            </div>
                            {% else %}
                            <span class="text-muted">—</span>
                            {% endif %}
                        </td>

                        <!-- Локация и Категория техники -->
                        {% if not profile or profile.role.code == 'employee' %}
                        <td>{{ req.location.name }}</td>
                        {% endif %}

                        <td>{{ req.equipment_category.name }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="14" class="text-center">Нет заявок</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js "></script>
    <!-- Select2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <!-- Flatpickr JS -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr "></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ru.js "></script>
    <!-- ExcelJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <!-- FileSaver.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<script>
$(function(){
    // ========================
    // Переменные
    // ========================
    const $statusFilter     = $('#statusFilter');
    const $locationFilter   = $('#locationFilter');
    const $categoryFilter   = $('#categoryFilter');
    const $requestsTableBody= $('#requestsTable tbody');
    let sortDirection       = "desc";
    let dateStartPicker, dateEndPicker;

    // Массив столбцов по умолчанию для экспорта
    const defaultColumns = [
        'ID',
        'Дата подачи',
        'Время подачи',
        'Подразделение',
        'Ответственный',
        'Заказчик',
        'Дата начала работы',
        'Дата окончания работы',
        'Время начала работ',
        'Время окончания работ',
        'Окончание работ по факту',
        'Перерывы',
        'Объем работы (ч)',
        'Локация',
        'Категория',
        'Вид транспорта',
        'Вид работ',
        'Объект работ',
        'Статус',
        'Комментарий',
        'Номер удостоверения ответственного',
        'ФИО стропольщика',
        'Номера удостоверений стропольщиков'
    ];

    // ========================
    // Инициализация flatpickr
    // ========================
    function initDatePickers(){
        const cfg = {
            locale: "ru",
            dateFormat: "Y-m-d",
            altFormat:  "d.m.Y",
            altInput:   true,
            allowInput: true,
            onChange:   filterRequests
        };
        dateStartPicker = flatpickr("#dateStartFilter", cfg);
        dateEndPicker   = flatpickr("#dateEndFilter",   cfg);
    }

    // ========================
    // Сортировка по дате
    // ========================
    function initSorting(){
        $("#sortDateHeader").on("click", function(){
            const rows = $requestsTableBody.find("tr").get();
            sortDirection = sortDirection === "asc" ? "desc" : "asc";
            $(this).removeClass("asc desc").addClass(sortDirection);
            rows.sort((a,b)=>{
                const da = new Date(a.getAttribute("created-at"));
                const db = new Date(b.getAttribute("created-at"));
                return sortDirection==="asc" ? da-db : db-da;
            });
            $requestsTableBody.append(rows);
        });
    }

    // ========================
    // Сбор и запись условий поиска
    // ========================
    function updateSearchConditions(){
        const terms = $('.search-input')
            .map((_,el)=>el.value.trim())
            .get()
            .filter(Boolean);
        $('#searchConditions').val(JSON.stringify(terms));
    }

    // ========================
    // Фильтрация всех строк
    // ========================
    function filterRequests(){
        const searchTerms = $('.search-input').map(function(){
            return $(this).val().trim().toLowerCase();
        }).get().filter(Boolean);

        const filters = {
            status:    $statusFilter.val(),
            location:  $locationFilter.val(),
            category:  $categoryFilter.val(),
            dateStart: $("#dateStartFilter").val(),
            dateEnd:   $("#dateEndFilter").val()
        };

        $requestsTableBody.find("tr").each(function(){
            const $row = $(this);
            const data = {
                id:           String($row.data("id")),
                status:       $row.data("status"),
                location:     $row.data("location"),
                category:     $row.data("equipment-category"),
                customer:     $row.data("customer")   || "",
                responsible:  $row.data("responsible")|| "",
                workType:     $row.data("work-type")  || "",
                workObject:   $row.data("work-object")|| "",
                transportType:$row.data("transport-type")||"",
                department:   $row.data("department") || "",
                dateStart:    $row.data("date-start"),
                dateEnd:      $row.data("date-end"),
                timeStart:    $row.data("time-start") || "",
                timeEnd:      $row.data("time-end") || "",
                isCompletedFact: $row.data("is-completed-fact") === "yes",
                breakPeriods: $row.data("break-periods") || [],
                comment:      $row.data("comment") || "",
                responsibleCertificate: $row.data("responsible-id-card") || "",
                slingers:     $row.data("slingers") || { names: "", certificates: "" }
            };

            // Текстовый поиск
            const matchesSearch = searchTerms.every(term=>
                data.id.includes(term) ||
                data.workType.toLowerCase().includes(term) ||
                data.workObject.toLowerCase().includes(term) ||
                data.transportType.toLowerCase().includes(term) ||
                data.customer.toLowerCase().includes(term) ||
                data.responsible.toLowerCase().includes(term) ||
                data.department.toLowerCase().includes(term)
            );

            // Селекты и даты
            const matches = {
                status:   !filters.status   || data.status   === filters.status,
                location: !filters.location || data.location === filters.location,
                category: !filters.category || data.category === filters.category,
                date:     (!filters.dateStart && !filters.dateEnd) ||
                        (
                            data.dateStart && data.dateEnd &&
                            (!filters.dateStart || data.dateStart >= filters.dateStart) &&
                            (!filters.dateEnd   || data.dateEnd   <= filters.dateEnd)
                        )
            };

            // Итоговый результат
            const isVisible = matchesSearch && matches.status && matches.location && matches.category && matches.date;
            $row.toggle(isVisible);
        });
        
        updateUrlParams();
    }

    // ========================
    // Обновление URL-параметров
    // ========================
    function updateUrlParams(){
        const p = new URLSearchParams();
        const vals = {
            status:   $statusFilter.val(),
            location: $locationFilter.val(),
            category: $categoryFilter.val(),
            date_start: $("#dateStartFilter").val(),
            date_end:   $("#dateEndFilter").val()
        };
        Object.entries(vals).forEach(([k,v])=>v && p.set(k,v));
        history.replaceState(null,'',window.location.pathname+'?'+p.toString());
    }

    // ========================
    // Динамический поиск: +, x, авто‑фильтрация
    // ========================
    // 1) превращаем главный input в search-input
    $('#searchInput').addClass('search-input');

    // 2) добавление по "+"
    $('#add-search-btn').on('click',function(){
        const v = $('#searchInput').val().trim();
        if(!v) return;
        const $row = $(`
            <div class="input-group mb-1 search-row">
                <input type="text" class="form-control search-input" value="${v}" placeholder="Поиск по заявкам...">
                <button type="button" class="btn btn-danger btn-sm remove-search-btn"><i class="bi bi-x"></button>
            </div>
        `);
        $('#add-search-container').append($row);
        $('#searchInput').val('');
        updateSearchConditions();
        filterRequests();
    });

    // 3) удаление строки
    $(document).on('click','.remove-search-btn',function(){
        $(this).closest('.search-row').remove();
        updateSearchConditions();
        filterRequests();
    });

    // 4) авто‑фильтрация при вводе
    $(document).on('input','.search-input',function(){
        updateSearchConditions();
        filterRequests();
    });

    // ========================
    // Очистка всех фильтров
    // ========================
    function clearAllFilters(){
        // поиск
        $('#add-search-container').empty();
        $('#searchInput').val('');
        $('#searchConditions').val('');
        // селекты
        $statusFilter.val('').trigger('change');
        $locationFilter.val('').trigger('change');
        $categoryFilter.val('').trigger('change');
        // даты и сортировка
        dateStartPicker.clear();
        dateEndPicker.clear();
        $('#sortDateHeader').removeClass('asc desc');
        sortDirection = 'desc';
        filterRequests();
    }

    $('#clearAllFilter').attr('type','button').off('click').on('click', e=>{
        localStorage.removeItem('savedFilters');
        e.preventDefault();
        clearAllFilters();
    });

    // ========================
    // Цвета статусов
    // ========================
    function applyStatusColor($el) {
        $el.removeClass('status-new status-assigned status-work status-done status-cancel');
        const code = $el.data('code') || $el.find('option:selected').data('code');
        if (code) $el.addClass(`status-${code}`);
    }

    function initStatuses() {
        $('.change-status, .status-badge.change-status').each(function () {
            applyStatusColor($(this));
        });
        $('.change-status').filter('select').on('change', function () {
            const $sel = $(this);
            const id = $sel.data("id");
            const stId = $sel.val();
            const stCode = $sel.find('option:selected').data('code');
            $sel.data('code', stCode);
            applyStatusColor($sel);
            fetch("{% url 'update_status' %}", {
                method: "POST",
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ request_id: id, status_id: stId })
            })
            .then(r => r.json())
            .then(js => { 
                if (!js.success) alert('Ошибка: ' + js.error); 
            });
        });
    }

    // ========================
    // Инициализация селектов ответственных
    // ========================
    function initResponsibleSelects() {
        function formatResponsible(option) {
            if (!option.id) return option.text;
            const position = $(option.element).data('position') || '';
            return $(`<div><div>${option.text}</div><small class="text-muted">${position}</small></div>`);
        }

        $('.change-responsible').select2({
            theme: 'bootstrap-5',
            placeholder: 'Выберите ответственного',
            allowClear: false,
            width: 'resolve',
            templateResult: formatResponsible,
            templateSelection: formatResponsible,
            escapeMarkup: m => m
        }).on("change", function () {
            const $sel = $(this);
            const requestId = $sel.data("id");
            const responsibleId = $sel.val();
            fetch("{% url 'update_responsible' %}", {
                method: "POST",
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ request_id: requestId, responsible_id: responsibleId })
            })
            .then(r => r.json())
            .then(js => { 
                if (!js.success) alert('Ошибка: ' + js.error); 
            });
        });
    }

    // ========================
    // Сохранение фильтров
    // ========================
    function saveCurrentFilters() {
        const filters = {
            status:   $statusFilter.val(),
            location: $locationFilter.val(),
            category: $categoryFilter.val(),
            dateStart: $("#dateStartFilter").val(),
            dateEnd:   $("#dateEndFilter").val(),
            searchTerms: $('.search-input')
                .map((_, el) => $(el).val().trim())
                .get()
                .filter(Boolean)
        };
        try {
            localStorage.setItem('savedFilters', JSON.stringify(filters));
            alert('Фильтры успешно сохранены!');
        } catch (e) {
            console.error('Ошибка сохранения в localStorage', e);
            alert('Не удалось сохранить фильтры (localStorage переполнен или недоступен)');
        }
    }

    // Привязка к кнопке
    $('#saveFiltersBtn').on('click', function () {
        saveCurrentFilters();
    });

    // ========================
    // Загрузка сохранённых фильтров
    // ========================
    function loadSavedFilters() {
        const saved = localStorage.getItem('savedFilters');
        if (!saved) return;
        try {
            const filters = JSON.parse(saved);
            // Установка значений фильтров
            if (filters.status)     $statusFilter.val(filters.status);
            if (filters.location)   $locationFilter.val(filters.location);
            if (filters.category)   $categoryFilter.val(filters.category);
            if (filters.dateStart)  dateStartPicker.setDate(filters.dateStart);
            if (filters.dateEnd)    dateEndPicker.setDate(filters.dateEnd);
            // Очистка текущих поисковых строк
            $('#add-search-container').empty();
            // Восстановление поисковых строк
            filters.searchTerms.forEach(term => {
                const $row = $(`
                    <div class="input-group mb-1 search-row">
                        <input type="text" class="form-control search-input" value="${term}" placeholder="Поиск по заявкам...">
                        <button type="button" class="btn btn-danger btn-sm remove-search-btn"><i class="bi bi-x"></i></button>
                    </div>
                `);
                $('#add-search-container').append($row);
            });
            updateSearchConditions();
        } catch (e) {
            console.error('Ошибка при загрузке фильтров из localStorage', e);
        }
    }

    // ========================
    // Генерация Excel
    // ========================
    async function generateExcel(headers, data) {
        const wb = new ExcelJS.Workbook();
        const ws = wb.addWorksheet('Заявки', { views: [{ state: 'frozen', ySplit: 1 }] });

        // Добавляем заголовки
        ws.addRow(headers);

        // Добавляем данные
        data.forEach(r => ws.addRow(r));

        // Стили
        ws.columns.forEach((col, i) => {
            col.eachCell((cell, rowNumber) => {
                cell.alignment = { vertical: 'middle', horizontal: 'center', wrapText: true };
                cell.border = {
                    top: { style: 'thin' }, left: { style: 'thin' },
                    bottom: { style: 'thin' }, right: { style: 'thin' }
                };
                if (rowNumber === 1) {
                    cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFDDDDDD' }};
                    cell.font = { bold: true };
                }
            });

            // Автоподгонка ширины
            let max = 10;
            col.eachCell(cell => {
                const v = cell.value ? cell.value.toString() : '';
                max = Math.max(max, v.length);
            });
            col.width = max + 2;
        });

        // Имя файла
        const today = new Date();
        const dd = String(today.getDate()).padStart(2, '0');
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const yyyy = today.getFullYear();
        const filename = `Заявки ${dd}.${mm}.${yyyy}.xlsx`;

        // Сохранение
        const buf = await wb.xlsx.writeBuffer();
        saveAs(new Blob([buf], { type: 'application/octet-stream' }), filename);
    }
        
    // ========================
    // Инициализация модального окна выбора столбцов
    // ========================
    function initExportColumnModal() {
        const $modal = $('#exportColumnsModal');
        const checkboxes = $modal.find('.column-checkbox');

        // Загрузка сохранённых значений из localStorage
        function loadSavedColumns() {
            const saved = localStorage.getItem('exportColumns');
            if (saved) {
                const selected = JSON.parse(saved);
                checkboxes.each(function () {
                    const val = $(this).val();
                    $(this).prop('checked', selected.includes(val));
                });
            } else {
                checkboxes.prop('checked', false);
                checkboxes.each(function () {
                    const val = $(this).val();
                    $(this).prop('checked', defaultColumns.includes(val));
                });
            }
        }

        // Открытие модального окна
        $('#exportExcelBtn').on('click', function (e) {
            e.preventDefault();
            loadSavedColumns();
            $modal.modal('show');
        });

        // Сброс выбора
        $('#resetColumnsBtn').on('click', function () {
            checkboxes.prop('checked', false);
            checkboxes.each(function () {
                const val = $(this).val();
                $(this).prop('checked', defaultColumns.includes(val));
            });
        });

        // Сохранение выбора и экспорт
        $('#saveExportColumnsBtn').on('click', function () {
            const selected = checkboxes.filter(':checked').map(function () {
                return $(this).val();
            }).get();
            localStorage.setItem('exportColumns', JSON.stringify(selected));
            exportToExcel(selected);
        });
    }

    // ========================
    // формат для дат при экспорте
    // ========================
    function formatDate(dateStr) {
        if (!dateStr) return '';
        const date = new Date(dateStr);
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0'); // Месяцы с 0
        const year = date.getFullYear();
        return `${day}.${month}.${year}`;
    }
    
    // Форматирует строку: "иванов иван" → "Иванов иван"
    function capitalizeFirstLetter(str) {
        if (typeof str !== 'string' || !str.trim()) return str;
        return str.charAt(0).toUpperCase() + str.slice(1).toLowerCase();
    }

    // Форматирует строку: "иванов иван" → "Иванов Иван"
    function capitalizeWords(str) {
        if (typeof str !== 'string' || !str.trim()) return str;
        return str.toLowerCase().split(' ')
            .filter(Boolean)
            .map(word => word.charAt(0).toUpperCase() + word.slice(1))
            .join(' ');
    }
    // ========================
    // Функция экспорта в Excel
    // ========================
    function exportToExcel(selectedColumns) {
        const headers = selectedColumns;
        const data = [];
        $('#requestsTable tbody tr:visible').each(function () {
            const $tr = $(this);
            const row = [];
            headers.forEach(header => {
                let value = ' ';
                switch (header) {
                    case 'ID':
                        value =  $tr.data('id') || '';
                        break;
                    case 'Дата подачи':
                        value =  formatDate($tr.data('submitted')?.split('T')[0]);
                        break;
                    case 'Время подачи':
                        value =  $tr.data('submitted')?.split('T')[1]?.slice(0, 5) || '';
                        break;
                    case 'Подразделение':
                        value =  $tr.data('department') || '';
                        break;
                    case 'Ответственный':
                        value =  $tr.data('responsible') || '';
                        break;
                    case 'Заказчик':
                        value =  $tr.data('customer') || '';
                        break;
                    case 'Дата начала работы':
                        value =  formatDate($tr.data('date-start'));
                        break;
                    case 'Дата окончания работы':
                        value =  formatDate($tr.data('date-end'));
                        break;
                    case 'Время начала работ':
                        value =  $tr.data('time-start') || '';
                        break;
                    case 'Время окончания работ':
                        value =  $tr.data('time-end') || '';
                        break;
                    case 'Окончание работ по факту':
                        value =  $tr.data('is-completed-fact') ? 'Да' : 'Нет';
                        break;
                    case 'Перерывы': {
                        // 1) Достаём «сырую» строку из атрибута
                        const raw = $tr.attr('data-break-periods') || '[]';
                        let breaksArr = [];

                        // 2) Пробуем распарсить
                        try {
                            breaksArr = JSON.parse(raw);
                        } catch (e) {
                            console.warn('Невалидный JSON в data-break-periods:', raw);
                        }

                        // 3) Если это массив — соединяем в строку, иначе возвращаем пустую
                        value = Array.isArray(breaksArr)
                            ? breaksArr.join(', ')
                            : '';
                        break;
                    }
                    case 'Объем работы (ч)': {
                        const ds = $tr.data('date-start');
                        const de = $tr.data('date-end');
                        const ts = $tr.data('time-start') || '';
                        const te = $tr.data('time-end') || '';
                        if (ds && ts && de && te) {
                            const start = new Date(`${ds}T${ts}`);
                            const end = new Date(`${de}T${te}`);
                            const hrs = (end - start) / 36e5;
                            value = Math.round(hrs * 100) / 100;
                        }else{
                            value = '';
                        }
                        break;
                    }
                    case 'Локация':
                        value = $tr.data('location-name') || '';
                        break;
                    case 'Категория':
                        value = $tr.data('equipment-category-name') || '';
                        break;
                    case 'Вид транспорта':
                        value = $tr.data('transport-type') || '';
                        break;
                    case 'Вид работ':
                        value = $tr.data('work-type') || '';
                        break;
                    case 'Объект работ':
                        value = $tr.data('work-object') || '';
                        break;
                    case 'Статус':
                        value = $tr.data('status-name') || '';
                        break;
                    case 'Комментарий':
                        value = $tr.data('comment') || '';
                        break;
                    case 'Номер удостоверения ответственного':
                        value = $tr.data('responsible-id-card') || '';
                        break;
                    case 'ФИО стропольщика':
                        value = $tr.data('slingers')?.names || '';
                        break;
                    case 'Номера удостоверений стропольщиков':
                        value = $tr.data('slingers')?.certificates || '';
                        break;
                    default:
                        value = '';
                }
                
                // Применяем форматирование
                if (typeof value === 'string' && value.trim()) {
                    if (header === 'Ответственный' || header === 'Заказчик') {
                        row.push(capitalizeWords(value));
                    } else {
                        row.push(capitalizeFirstLetter(value));
                    }
                } else {
                    row.push(value);
                }
            });

            data.push(row);
        });

        // 5) Генерируем Excel
        generateExcel(headers, data);
    }


    // ========================
    // Старт
    // ========================
    function init(){
        initDatePickers();
        initSorting();
        initStatuses();
        initResponsibleSelects();
        loadSavedFilters(); // Загрузка сохранённых фильтров
        
        // Привязка change-событий на селекты
        $statusFilter.on('change', filterRequests);
        $locationFilter.on('change', filterRequests);
        $categoryFilter.on('change', filterRequests);
        
        // Инициализация модального окна
        initExportColumnModal();
        
        // Инициализация фильтрации
        filterRequests();
    }
    
    init();
});
</script>
</body>
</html>