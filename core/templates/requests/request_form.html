<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8" />
    <title>Создать заявку</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

    <!-- Select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

    <!-- Flatpickr CSS -->
    <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet" />

    <!-- Иконки -->
    {% load static %}
    <link rel="icon" href="{% static 'img/favicon.png' %}" type="image/png" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

    <style>
        body {
            background-color: #f8f9fa;
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        }

        .form-container {
            max-width: 100%;
            margin: 0 auto;
            background-color: white;
            padding: 1rem 2.5rem;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        }

        .form-title {
            position: relative;
            display: inline-block;
            padding-bottom: 6px;
            white-space: nowrap;
            margin-bottom: 20px;
        }

        .form-title::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 3px;
            transform: scaleX(1);
            transform-origin: left center;
            background: linear-gradient(90deg, #8e3798, #574ca1, #4da4cb);
            transition: transform 0.3s ease;
        }

        .form-label {
            font-weight: 600;
            color: #5a5a5a;
            margin-bottom: 0;
            font-size: calc(0.7rem + .4vw);
        }

        input,
        select,
        textarea {
            border-radius: 8px;
            border: 1px solid #ced4da;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            height: 40px;
            width: 100%;
            padding: 6px 12px;
        }

        input#id_is_completed_fact{
            padding: 0 !important;
        }

        select {
            padding: 0.375rem 0.75rem;
        }

        .form-control:focus {
            border-color: #574ca1;
            box-shadow: 0 0 0 0.2rem rgba(87, 76, 161, 0.25);
        }

        .invalid-feedback {
            color: #dc3545;
            font-size: calc(0.5rem + .4vw);
            margin-top: 0.25rem;
        }

        .back-link {
            display: inline-block;
            text-decoration: none;
            color: #574ca1;
            font-weight: 500;
            transition: color 0.3s ease;
        }

        .back-link:hover {
            color: #4da4cb;
        }
        .btn-gradient {
            background: transparent;
            color: #574ca1;
            border: 1px solid #574ca1;
            margin-top: 2px;
        }

        .btn-gradient:hover {
            opacity: 0.9;
            color: white;
            background: linear-gradient(135deg, #574ca1, #4da4cb);
        }
        .form-section {
            background-color: #f8f9fa;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            border-left: 4px solid #8e3798;
        }

        .form-section h6 {
            color: #5a5a5a;
            font-weight: 600;
            margin-bottom: calc(0.6rem + 0.3vw);
            font-size: calc(0.7rem + .7vw);
        }

        .input-group-text {
            background: #f1f3f5;
            border-radius: 8px 0 0 8px;
            border-right: none;
        }

        .form-control.input-group-lg {
            border-radius: 0 8px 8px 0;
        }
        
        .select2-container--bootstrap-5 .select2-selection--single {
            background-color: #fff;         
            border: 1px solid #ced4da;    
            border-radius: 8px;            
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            height: calc(1rem + 4vh);                
            padding: 6px 12px;             
            width: 100% !important;    
            transition: all 0.3s ease;
        }

        .form-check-label {
            margin-top: 0; 
            margin-bottom: 0;
            font-size: calc(0.6rem + .4vw);
        }

        .form-check-input {
            width: 20px;
            height: 20px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            background-color: white;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            transition: all 0.2s ease-in-out;
            position: relative;
        }

        .form-check-input:checked {
            background-color: #574ca1;
            border-color: #574ca1;
        }

        .form-check-input:checked::after {
            content: "";
            position: absolute;
            top: 2px;
            left: 6px;
            width: 6px;
            height: 12px;
            border: solid white;
            border-width: 0 3px 3px 0;
            transform: rotate(45deg);
        }

        .form-check-input:focus {
            box-shadow: 0 0 0 0.2rem rgba(87, 76, 161, 0.25);
        }

        .form-check-input:checked[type="checkbox"] {
            background-image: none !important;
        }


        .select2-container--default .select2-selection--single:focus {
            border-color: #574ca1 !important;
            box-shadow: 0 0 0 0.2rem rgba(87, 76, 161, 0.25);
        }

        .flatpickr-input {
            background-color: white !important;
            border-radius: 8px;
            border: 1px solid #ced4da;
            padding: 0.375rem 0.75rem;
        }

        .lifting-fields {
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-control[readonly] {
            background-color: #e9ecef !important;
        }

        .text-muted.small-hint {
            font-size: 0.85em;
            color: #868e96 !important;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-floating {
            margin-bottom: 1rem;
        }

        .star {
            color: #dc3545;
        }

        .responsive-cancel-btn .btn-text {
            margin-left: 8px;
        }


        /* Текст и стрелка внутри селекта */
        .select2-container--bootstrap-5 .select2-selection__rendered {
            line-height: 1.5;               
            color: #495057;
        }

        .select2-container--bootstrap-5 .select2-selection__arrow {
            height: 100%;
        }

        /* При фокусе — подсветка, как у form-control:focus */
        .select2-container--bootstrap-5 .select2-selection--single:focus,
        .select2-container--bootstrap-5 .select2-selection--single:focus-within {
            border-color: #574ca1;
            box-shadow: 0 0 0 0.2rem rgba(87, 76, 161, 0.25);
            outline: none;
        }
    
        #id_break_periods { display: none !important; }
        .break-row { 
            display: flex; 
            align-items: center; 
            gap: .5rem; 
            margin-bottom: .5rem; }
        .break-label { 
            font-size: .9rem; }
        .btn-remove-break { 
            background: none; 
            border: none; 
            color: #dc3545; 
            font-size: 1.2rem; 
            line-height:1; 
        }
        .no-row-gap {
            margin-top: 0 !important;
        }

        #liftingFields {
            display: none; /* Это нормально, JS будет менять на 'block' */
        }
        @media (max-width: 700px) {
            .responsive-cancel-btn .btn-text {
                display: none;
            }

            .responsive-cancel-btn i {
                margin: 0;
                width: 48px;
                height: 48px;
                font-size: 24px; 
                display: flex;
                align-items: center;
                justify-content: center;
            }
            .form-title 
            {
                padding-bottom: 3px !important;
                margin-bottom: 10px !important;
            }
        }

        @media (max-width: 418px) {
            input#id_work_object,
            input#id_work_type,
            input.form-control,
            input#id_date_start,
            input#id_date_end,
            input#id_time_start,
            input#id_time_end,
            input#id_transport_type,
            input#id_break_time,
            input#id_equipment_category,
            select,
            textarea {
                padding: 2px 5px !important;
                height: 30px;
                font-size: calc(0.6rem + .4vw) !important;
            }
            .select2-container {
                height: 50px !important;
                font-size: calc(0.6rem + .4vw) !important;
            }
            .content-data{
                display: block;
            }
            .content-time{
                display: block;
            }
            .col-6{
                width: 100%;
            }
            .form-section{
                padding: .5rem;
                margin-bottom: .8rem;
            }
            .row>*{
                margin-top: .5rem;
            }
            .form-container{
                padding: .6rem .8rem;
            }
        }
    </style>
</head>

<body>
    <div class="form-container">
        <h2 class="form-title">
            {% if form.instance.pk %} Редактировать заявку {% else %} Создать заявку
            {% endif %}
        </h2>
        <span class="title-line"></span>
        <form method="post" novalidate>
            <!-- Все ошибки формы -->
            {% csrf_token %} 
            <!-- {{ form.non_field_errors }} {{ form.errors }} -->
            

            <div class="row card-row">
                <!-- Основная информация -->
                <div class="col-md-6 form-section">
                    <h6>Основная информация</h6>
                    <div class="row g-3" style="min-width: 300px">
                        <!-- Локация -->
                        <div class="col-md-6">
                            <label for="{{ form.location.id_for_label }}" class="form-label">Локация<span
                                    class="star">*</span></label>
                            {{ form.location }} 
                            {% if form.location.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.location.errors.as_text }}
                            </div>
                            {% endif %}
                        </div>

                        <!-- Объект работ -->
                        <div class="col-md-6">
                            <label for="{{ form.work_object.id_for_label }}" class="form-label">Объект работ<span
                                    class="star">*</span></label>
                            {{ form.work_object }} 
                            {% if form.work_object.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.work_object.errors.as_text }}
                            </div>
                            {% endif %}
                        </div>

                        <!-- Вид работ -->
                        <div class="col-md-6">
                            <label for="{{ form.work_type.id_for_label }}" class="form-label">Вид работ<span
                                    class="star">*</span></label>
                            {{ form.work_type }} 
                            {% if form.work_type.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.work_type.errors.as_text }}
                            </div>
                            {% endif %}
                        </div>

                        <!-- Транспорт -->
                        <div class="col-md-6">
                            <label for="{{ form.transport_type.id_for_label }}" class="form-label">Транспорт<span
                                    class="star">*</span></label>
                            {{ form.transport_type }} 
                            {% if form.transport_type.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.transport_type.errors.as_text }}
                            </div>
                            {% endif %}
                        </div>


                        <!-- Категория техники -->
                        {% if form.equipment_category %}
                        <div class="col-md-6">
                            <label for="{{ form.equipment_category.id_for_label }}" class="form-label">
                                Категория техники<span class="star">*</span>
                            </label>
                            <select name="equipment_category" id="id_equipment_category" class="form-select">
                                {% for category in form.fields.equipment_category.queryset %}
                                    <option value="{{ category.id }}"
                                            data-code="{{ category.code }}"
                                            {% if form.equipment_category.value == category.id|stringformat:"s" or category.id == form.initial.equipment_category %}selected{% endif %}>
                                        {{ category.name }}
                                    </option>
                                {% endfor %}
                            </select>

                            {% if form.equipment_category.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.equipment_category.errors.0 }}
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}

                        <!-- Статус заявки (только если поле есть в форме) -->
                        {% if form.status %}
                        <div class="col-md-6">
                            <label for="{{ form.status.id_for_label }}" class="form-label">Статус заявки:<span
                                    class="star">*</span></label>
                            <!-- {{ form.status.label_tag }} -->
                            {{ form.status }}
                            {% if form.status.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.status.errors.as_text }}
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}

                    </div>
                </div>

                <!-- Период работ -->
                <div class="col-md-6 form-section">
                    <h6>Период работ</h6>
                    <div class="row g-3" style="min-width: 300px">
                        
                        <!-- Блок под расчет часов -->
                        <div class="col-12 mb-0">
                            <p id="timeDifference" class="text-muted mb-0" style="font-size: calc(0.75rem + 0.1vw);">
                                ⏱ Продолжительность времени (автоматически): —
                            </p>
                        </div>

                        <!-- Дата начала и окончания -->
                        <div class="col-12">
                            <div class="row content-data">
                                <div class="col-6">
                                    <label for="{{ form.date_start.id_for_label }}" class="form-label">Дата начала<span
                                            class="star">*</span></label>
                                    {{ form.date_start }} 
                                    {% if form.date_start.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.date_start.errors.as_text }}
                                        
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="col-6">
                                    <label for="{{ form.date_end.id_for_label }}" class="form-label">Дата окончания<span
                                            class="star">*</span></label>
                                    {{ form.date_end }} 
                                    {% if form.date_end.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.date_end.errors.as_text }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Время начала и окончания -->
                        <div class="col-12 mb-2">
                            <div class="row content-time">
                                <div class="col-6">
                                    <label for="{{ form.time_start.id_for_label }}" class="form-label">Время начала<span
                                            class="star">*</span></label>
                                    {{ form.time_start }} 
                                    {% if form.time_start.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.time_start.errors.as_text }}
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="col-6">
                                    <label for="{{ form.time_end.id_for_label }}" class="form-label">Время
                                        окончания<span class="star">*</span></label>
                                    {{ form.time_end }} 
                                    {% if form.time_end.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.time_end.errors.as_text }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Перерывы -->
                        <div class="col-12 no-row-gap">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label for="id_break_periods" class="form-label mb-0">{{ form.break_periods.label }}</label>
                                <button type="button" class="btn btn-outline-primary btn-sm" id="add-break-btn">
                                    <i class="bi bi-plus-lg"></i>
                                </button>
                            </div>

                            <div id="break-periods-container">
                            {# сюда JS подставит существующие или новые строки #}
                            </div>

                            {{ form.break_periods }}  {# это <textarea id="id_break_periods"> #}
                            {% if form.break_periods.help_text %}
                            <small class="form-text text-muted">{{ form.break_periods.help_text }}</small>
                            {% endif %}
                            {% if form.break_periods.errors %}
                            <div class="invalid-feedback d-block">{{ form.break_periods.errors.as_text }}</div>
                            {% endif %}
                        </div>

                        <!-- По факту -->
                        <div class="col-12 mt-0">
                            <div class="form-check d-flex align-items-center gap-2">
                                <input class="form-check-input" type="checkbox"
                                    id="{{ form.is_completed_fact.id_for_label }}"
                                    name="{{ form.is_completed_fact.html_name }}"
                                    {% if form.is_completed_fact.value %}
                                        checked
                                    {% endif %}
                                    />

                                <label class="form-check-label mt-1 mb-0" for="{{ form.is_completed_fact.id_for_label }}">
                                    До окончания работ по факту
                                </label>
                            </div>

                            {% if form.is_completed_fact.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.is_completed_fact.errors.as_text }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Ответственные лица -->
                <div class="col-md-6 form-section">
                    <div class="row g-3">
                        <!-- Ответственный -->
                        <div class="col-md-12">
                        <label for="id_responsible" class="form-label">
                            Ответственный<span class="star">*</span>
                        </label>
                        <select id="id_responsible"
                                name="responsible"
                                class="form-select change-responsible"
                                data-id="{{ form.instance.pk|default:'' }}"
                                style="width:100%">
                            <option value="">—</option>
                            {% for p in responsibles %}
                            <option value="{{ p.id }}"
                                    data-department="{% if profile and profile.role.code == 'operator' %}{{ p.department.organization.name }} — {{ p.department.name }}{% else %}{{ p.department.name }}{% endif %}"
                                    {% if form.instance.responsible_id == p.id %}selected{% endif %}>
                                {{ p.full_name }}
                            </option>
                            {% endfor %}
                        </select>
                        {% if form.responsible.errors %}
                            <div class="invalid-feedback d-block">
                            {{ form.responsible.errors.as_text }}
                            </div>
                        {% endif %}
                        </div>
                        {% if profile and profile.role.code == 'operator' %}
                        <!-- Заказчик (для операторов) -->
                        <div class="col-md-12">
                            <label for="id_customer" class="form-label">
                                Заказчик<span class="star">*</span>
                            </label>
                            <select id="id_customer"
                                    name="customer"
                                    class="form-select change-customer"
                                    style="width:100%">
                                <option value="">—</option>
                                {% for p in customers %}
                                <option value="{{ p.id }}"
                                        data-department="{{ p.department}}"
                                        {% if form.instance.customer_id == p.id %}selected{% endif %}>
                                    {{ p.full_name }}
                                </option>
                                {% endfor %}
                            </select>
                            {% if form.customer.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.customer.errors.as_text }}
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Комментарий -->
                <div class="col-md-6 form-section">
                    <div class="row g-3">
                        <div class="col-12">
                            <label for="{{ form.comment.id_for_label }}" class="form-label">Комментарий</label>
                            {{ form.comment }} 
                            {% if form.comment.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.comment.errors.as_text }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Подъемные сооружения -->
                <div class="col-md-6 form-section lifting-fields" id="liftingFields">
                    <h6>Дополнительная информация для подъемных сооружений</h6>
                    <div class="row g-3">
                        <!-- Номер удостоверения ответственного -->
                        <div class="col-12">
                            <label for="{{ form.responsible_certificate.id_for_label }}" class="form-label">Номер
                                удостоверения ответственного<span class="star">*</span></label>
                            {{ form.responsible_certificate }} 
                            {% if form.responsible_certificate.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.responsible_certificate.errors.as_text }}
                            </div>
                            {% endif %}
                        </div>

                        <!-- ФИО стропальщика -->
                        <div class="col-12">
                            <label for="{{ form.rigger_name.id_for_label }}" class="form-label">ФИО стропальщиков<span
                                    class="star">*</span></label>
                            <small class="text-muted small-hint">Укажите через запятую</small>
                            {{ form.rigger_name }} 
                            {% if form.rigger_name.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.rigger_name.errors.as_text }}
                            </div>
                            {% endif %}
                        </div>

                        <!-- Номера удостоверений -->
                        <div class="col-12">
                            <label for="{{ form.rigger_certificates.id_for_label }}" class="form-label">Номера
                                удостоверений стропальщиков<span class="star">*</span></label>
                            <small class="text-muted small-hint">Укажите через запятую</small>
                            {{ form.rigger_certificates }} 
                            {% if form.rigger_certificates.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.rigger_certificates.errors.as_text }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Кнопки -->
            <div class="d-flex justify-content-between align-items-center">
                <a href="{% url 'request_list' %}" class="btn btn-outline-secondary">Отмена</a>
                <button type="submit" class="btn btn-gradient">
                    <i class="bi bi-save"></i>
                    <span>Сохранить заявку</span>
                </button>
            </div>
        </form>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Select2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <!-- Flatpickr JS -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ru.js"></script>

    <script>
        // Добавляет на страницу новую строку перерыва с заданным временем начала и конца.
        
        function addBreakPeriod(start = "", end = "") {
            const container = document.getElementById("break-periods-container");

            const row = document.createElement("div");
            row.className = "d-flex align-items-center gap-2 mb-2 break-row";

            row.innerHTML = `
                <input type="time" class="form-control break-start" value="${start}">
                <span>до</span>
                <input type="time" class="form-control break-end" value="${end}">
                <button type="button" class="btn btn-sm btn-outline-danger remove-break-btn">&times;</button>
            `;

            container.appendChild(row);
        }

        // Добавить новую строку
        document.getElementById('add-break-btn')
            .addEventListener('click', () => addBreakPeriod());

        // Удаление строки
        document.getElementById('break-periods-container').addEventListener('click', function (e) {
            if (e.target.classList.contains('remove-break-btn')) {
                e.target.closest('.break-row').remove();
            }
        });

        // При сабмите сериализуем
        document.querySelector('form').addEventListener('submit', function () {
            const out = [];
            document.querySelectorAll('#break-periods-container .break-row').forEach(row => {
                const s = row.querySelector('.break-start').value;
                const e = row.querySelector('.break-end').value;
                if (s && e) out.push(`${s}-${e}`);
            });
            document.getElementById('id_break_periods').value = JSON.stringify(out);
        });

        // Считывает из скрытого <input id="id_break_periods"> JSON-массив перерывов и инициализирует их на форме.
        function initDatepickers() {
            // flatpickr для дат
            const datePickerConfig = {
                locale: "ru",
                dateFormat: "Y-m-d",
                altInput: true,
                altFormat: "d.m.Y",
                allowInput: true,
                onChange: function (selectedDates, dateStr, instance) {
                    instance.input.classList.toggle('is-invalid', selectedDates.length === 0);
                }
            };

            flatpickr("#id_date_start", datePickerConfig);
            flatpickr("#id_date_end", datePickerConfig);


            // flatpickr для времени
            flatpickr("#{{ form.time_start.id_for_label }}", {
                enableTime: true,
                noCalendar: true,
                dateFormat: "H:i",
                time_24hr: true,
            });

            flatpickr("#{{ form.time_end.id_for_label }}", {
                enableTime: true,
                noCalendar: true,
                dateFormat: "H:i",
                time_24hr: true,
            });
        }
        
        // Настраивает отображение для поля «ответственный» с кастомным шаблоном
        function formatPersonal(option) {
            if (!option.id) {
            return option.text; 
            }
            const fullName    = option.text;
            const department = $(option.element).data('department') || '';
            return $(`
            <div>
                <div><strong>${department}</strong></div>
                <small class="text-muted">${fullName}</small>
            </div>
            `);
        }

        // 2) Инициализация Select2 на нашем селекте
        $('.change-responsible').select2({
            theme: 'bootstrap-5',
            placeholder: 'Выберите ответственного',
            allowClear: false,
            width: 'resolve',
            templateResult: formatPersonal,
            templateSelection: formatPersonal,
            escapeMarkup: m => m
        });

         // Select2 для заказчика
        $('.change-customer').select2({
            theme: 'bootstrap-5',
            placeholder: 'Выберите заказчика',
            width: 'resolve',
            templateResult: formatPersonal,
            templateSelection: formatPersonal,
            escapeMarkup: m => m
        });

        // 3) AJAX‑обновление ответственного при выборе
        $('.change-responsible').on('change', function() {
            const $sel          = $(this),
                requestId    = $sel.data('id'),
                responsibleId= $sel.val();

            // если создаём новую заявку (нет ID) — просто вернёмся
            if (!requestId) return;

            fetch("{% url 'update_responsible' %}", {
            method: "POST",
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                request_id:     requestId,
                responsible_id: responsibleId
            })
            })
            .then(r => r.json())
            .then(js => {
            if (!js.success) {
                alert('Ошибка: ' + js.error);
            }
            });
        });

        document.addEventListener("DOMContentLoaded", function () {           
            // Глобальные ссылки на элементы времени
            const startInput = document.getElementById("id_time_start");
            const endInput = document.getElementById("id_time_end");
            const output = document.getElementById("timeDifference"); 
            
            // Код категории, при которой показываем блок «Подъемные сооружения»
            const LIFTING_CODE = 'lifting';
            const categorySelect = document.getElementById('id_equipment_category');
            const liftingBlock = document.getElementById('liftingFields');

            function toggleLiftingFields() {
                if (!categorySelect || !liftingBlock) return;

                const selectedOption = categorySelect.options[categorySelect.selectedIndex];
                const categoryCode = selectedOption.dataset.code || '';

                // Проверяем как текущий выбор, так и сохраненное значение
                const isLifting = categoryCode === LIFTING_CODE || 
                (selectedOption && selectedOption.selected && selectedOption.dataset.code === LIFTING_CODE);
        
                liftingBlock.style.display = isLifting ? 'block' : 'none';}

            if (categorySelect) {
                categorySelect.addEventListener('change', toggleLiftingFields);
                toggleLiftingFields(); // Проверка при загрузке страницы
            }

            function calculateTimeDifference() {
                if (!startInput || !endInput || !output) return;

                const start = startInput.value;
                const end = endInput.value;

                if (!start || !end) {
                    output.textContent = "⏱ Продолжительность времени (автоматически): —";
                    return;
                }

                const [startH, startM] = start.split(":").map(Number);
                const [endH, endM] = end.split(":").map(Number);

                const startMinutes = startH * 60 + startM;
                const endMinutes = endH * 60 + endM;

                const diff = endMinutes - startMinutes;

                if (diff <= 0) {
                    output.textContent = "⏱ Время окончания должно быть позже начала";
                    return;
                }

                const hours = Math.floor(diff / 60);
                const minutes = diff % 60;

                output.textContent = `⏱ Продолжительность времени (автоматически): ${hours} ч ${minutes} мин`;
            }

            // События времени
            if (startInput && endInput) {
                startInput.addEventListener("change", calculateTimeDifference);
                endInput.addEventListener("change", calculateTimeDifference);
                calculateTimeDifference();
            }

            let existing = [];
            try {
                const raw = document.getElementById('id_break_periods').value;
                if (raw) existing = JSON.parse(raw); // ["03:30-03:04", "16:30-16:00"]
            } catch (e) {}

            existing.forEach(str => {
                if (typeof str === "string" && str.includes("-")) {
                    const [start, end] = str.split("-");
                    addBreakPeriod(start, end);
                }
            });
            initDatepickers();
        });
    </script>
</body>

</html>